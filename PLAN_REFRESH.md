# Refresh Token 추가 작업 계획

## 목표
- 기존 JWT 기반 인증 흐름에 리프레시 토큰을 추가하여 만료된 액세스 토큰을 안전하게 재발급할 수 있게 한다.

## 현재 상태 파악
- JWT 발급: `CreateUser.usecase` / `LoginUser.usecase` 에서 액세스 토큰만 발급.
- 검증: `auth.middleware`에서 액세스 토큰 검증만 수행.
- 문서: `API.md`, `ENDPOINTS_AND_USAGE.md`에 리프레시 관련 내용 없음.

## 데이터 모델/스토리지 (결정)
- 별도 `RefreshToken` 테이블로 다중 디바이스 세션 관리.
- 토큰 원문은 클라이언트만 보유, 서버에는 해시 + 만료 시각 + 기기 메타(선택) 저장.

## 토큰 정책
- 만료: 리프레시 14~30일, 액세스 10~60분(기존 설정 유지/조정).
- 롤링 발급: `/refresh` 호출 시 새 리프레시를 발급하고 기존 해시는 폐기.
- 재사용 감지: 폐기된 리프레시가 다시 오면 해당 세션 폐기(필요 시 전 세션 폐기 옵션).

## API 설계
- `POST /api/auth/login`: 액세스 + 리프레시(서버 해시 저장) 동시 발급(기존 로그인 대체/확장).
- `POST /api/auth/refresh`: 리프레시 검증 후 새 액세스 + 새 리프레시(롤링, 이전 해시 폐기).
- `POST /api/auth/logout`: 리프레시 토큰 폐기(해시 삭제).
- 전달 방식: 웹은 httpOnly/secure/sameSite 쿠키 권장, 모바일/기타 클라이언트는 JSON 응답 후 안전 스토리지 보관.

## 구현 단계
1) 스키마 확장: Prisma 스키마 및 마이그레이션 추가(옵션 A or B 선택).
2) 설정 추가: 리프레시 토큰 만료, 시크릿/랜덤 길이 환경변수 추가.
3) 유스케이스 추가: `IssueRefreshToken`, `RefreshAccessToken`, `Logout` 등 구현.
4) 컨트롤러/라우터 확장: `/auth/login`, `/auth/refresh`, `/auth/logout` 엔드포인트 배선.
5) 미들웨어/유틸: 리프레시 토큰 생성/검증/해시 비교, 롤링 및 철회 처리.
6) 기존 흐름 정리: `/users/login` 응답 스키마 업데이트 또는 신규 auth 네임스페이스로 분리.

## 테스트
- 유닛: 리프레시 검증/만료/철회/재사용 감지, 롤링 시 이전 토큰 무효화.
- e2e: 회원가입/로그인 → 보호 라우트 접근 → 액세스 만료 시 `/refresh` → 재시도 성공, 로그아웃 후 실패 시나리오.

## 문서
- `API.md`, `ENDPOINTS_AND_USAGE.md`에 새 엔드포인트와 응답 스키마 추가.
